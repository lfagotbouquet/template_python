name: Auto-populate PR Body

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  populate-body:
    name: Generate PR Body
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Generate and update PR body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          # Fetch the current PR body
          CURRENT_BODY=$(gh pr view "$PR_NUMBER" --json body -q '.body')

          # Strip HTML comments, headers, whitespace, checklist items
          STRIPPED=$(echo "$CURRENT_BODY" \
            | sed 's/<!--.*-->//g' \
            | sed '/^## /d' \
            | sed '/^- \[.\]/d' \
            | sed '/^-$/d' \
            | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' \
            | sed '/^$/d')

          if [[ -n "$STRIPPED" ]]; then
            echo "PR body already has custom content. Skipping auto-populate."
            exit 0
          fi

          echo "PR body is empty or template-only. Generating content..."

          MERGE_BASE=$(git merge-base origin/"$BASE_REF" HEAD)

          # --- Collect commit messages ---
          COMMITS=$(git log --pretty=format:"- %s" "$MERGE_BASE"..HEAD)

          # --- Collect changed files with stats ---
          DIFF_STAT=$(git diff --stat "$MERGE_BASE"..HEAD)
          FILE_LIST=$(git diff --name-only "$MERGE_BASE"..HEAD)

          # --- Categorize changes ---
          TOTAL=$(echo "$FILE_LIST" | grep -c '.' || true)
          SRC_CHANGES=$(echo "$FILE_LIST" | grep -c '^src/' || true)
          TEST_CHANGES=$(echo "$FILE_LIST" | grep -c '^tests/' || true)
          DOC_CHANGES=$(echo "$FILE_LIST" | grep -cE '^(.github/.*\.md|.*README)' || true)
          CI_CHANGES=$(echo "$FILE_LIST" | grep -cE '^\.github/(workflows|dependabot)' || true)

          # --- Build summary line ---
          SUMMARY_PARTS=()
          [[ "$SRC_CHANGES" -gt 0 ]] && SUMMARY_PARTS+=("$SRC_CHANGES source file(s)")
          [[ "$TEST_CHANGES" -gt 0 ]] && SUMMARY_PARTS+=("$TEST_CHANGES test file(s)")
          [[ "$DOC_CHANGES" -gt 0 ]] && SUMMARY_PARTS+=("$DOC_CHANGES doc file(s)")
          [[ "$CI_CHANGES" -gt 0 ]] && SUMMARY_PARTS+=("$CI_CHANGES CI file(s)")

          if [[ ${#SUMMARY_PARTS[@]} -gt 0 ]]; then
            SUMMARY_LINE="This PR touches $(IFS=', '; echo "${SUMMARY_PARTS[*]}") across $TOTAL file(s) total."
          else
            SUMMARY_LINE="This PR modifies $TOTAL file(s)."
          fi

          # --- Write PR body to a temp file ---
          BODY_FILE=$(mktemp)
          {
            echo "## Summary"
            echo ""
            echo "$SUMMARY_LINE"
            echo ""
            echo "## Changes"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "<details>"
            echo "<summary>Diff stats</summary>"
            echo ""
            echo '```'
            echo "$DIFF_STAT"
            echo '```'
            echo ""
            echo "</details>"
            echo ""
            echo "## Testing"
            echo ""
            echo '- [ ] Tests pass locally (`python -m pytest tests/ -v`)'
            echo '- [ ] Pre-commit hooks pass (`pre-commit run --all-files`)'
            echo ""
            echo "## Related Issues"
            echo ""
            echo "<!-- Link any related issues: Fixes #123, Closes #456 -->"
          } > "$BODY_FILE"

          # Update the PR body from file
          gh pr edit "$PR_NUMBER" --body-file "$BODY_FILE"
          rm -f "$BODY_FILE"
          echo "PR body has been auto-populated."
